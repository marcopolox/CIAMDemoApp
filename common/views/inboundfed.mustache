<!doctype html>
<html lang="en">
{{>head}}
<body>
    <div class="app-container app-theme-white body-tabs-shadow fixed-sidebar fixed-header">
        {{>app-header}}               
        <div class="app-main">
                {{>side-menu}}    
                <div class="app-main__outer">
                    <div class="app-main__inner">
                        <div class="app-page-title">
                            <div class="page-title-wrapper">
                                <div class="page-title-heading">
                                    <div class="page-title-icon">
                                        <i class="pe-7s-magic-wand icon-gradient bg-mean-fruit">
                                        </i>
                                    </div>
                                    <div>Okta for CIAM
                                        <div class="page-title-subheading">Customer Identity Access Management (CIAM) & B2B Identity
                                        </div>
                                    </div>
                                </div> 
                                <div class="page-title-actions">
                                    <div class="d-inline-block dropdown">
                                        <button type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="btn-shadow dropdown-toggle btn btn-info">
                                            <span class="btn-icon-wrapper pr-2 opacity-7">
                                                <i class="fa fa-business-time fa-w-20"></i>
                                            </span>
                                            Links
                                        </button>
                                        <div tabindex="-1" role="menu" aria-hidden="true" class="dropdown-menu dropdown-menu-right">
                                            <ul class="nav flex-column">
                                                <li class="nav-item">
                                                    <a href="https://www.okta.com/products/customer-identity/b2b-integration/" class="nav-link">
                                                        <i class="nav-link-icon lnr-inbox"></i>
                                                        <span>
                                                            Inbound Federation
                                                        </span>
                                                    </a>
                                                </li>
                                                <li class="nav-item">
                                                    <a href="https://www.okta.com/integrate/documentation/saml/" class="nav-link">
                                                        <i class="nav-link-icon lnr-inbox"></i>
                                                        <span>
                                                            SAML
                                                        </span>
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>  
                            </div>
                        </div>
                        <ul class="body-tabs body-tabs-layout tabs-animated body-tabs-animated nav">
                            <li class="nav-item">
                                <a role="tab" class="nav-link active" id="tab-0" data-toggle="tab" href="#tab-content-0">
                                    <span>3rd Party IDP</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a role="tab" class="nav-link" id="tab-1" data-toggle="tab" href="#tab-content-1">
                                    <span>Okta 2 Okta</span>
                                </a>
                            </li>
                        </ul> 
                        <div class="tab-content">
                            <div class="tab-pane tabs-animation fade show active" id="tab-content-0" role="tabpanel"> 
                                <div class="row">
                                    <div class="col-lg-8">
                                        <div class="main-card mb-3 card">
                                            <div class="card-body"><h5 class="card-title">Inbound Federation Flow</h5>
                                            <img class="img-fluid" src="./assets/images/saml-flow.png" data-toggle="modal" data-target=".bd-example-modal-lg"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div id="widget-container" style="margin-top:-100px"></div>
                                    </div>
                                </div>  
                            </div>
                            <div class="tab-pane tabs-animation fade" id="tab-content-1" role="tabpanel">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <div class="main-card mb-3 card">
                                            <div class="card-body"><h5 class="card-title">Okta to Okta Flow (org2org)</h5>
                                            <img class="img-fluid" src="./assets/images/org2org.png" data-toggle="modal" data-target=".bd-example-modal-lg1"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div id="widget-container1" style="margin-top:-100px"></div>
                                    </div>
                                </div>  
                            </div>
                        </div>
                    </div>
                    <div id="tokens" style="display:none">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3 card text-white card-body" style="background-color: rgb(51, 51, 51); border-color: rgb(51, 51, 51);">
                                    <h5 class="text-white card-title">ID Token</h5>
                                    <textarea class="form-control" id="idtokendecoded" readonly rows="25" cols="100%" style="font-size:11px"></textarea>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="mb-3 card text-white card-body" style="background-color: rgb(51, 51, 51); border-color: rgb(51, 51, 51);">
                                    <h5 class="text-white card-title">Access Token</h5>
                                    <textarea class="form-control" id="accesstokendecoded" readonly rows="25" cols="100%" style="font-size:11px"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- Large modal -->
    <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">SAML flow</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img class="img-fluid" src="./assets/images/saml-flow.png"/>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <!--<button type="button" class="btn btn-primary">Save changes</button>-->
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade bd-example-modal-lg1" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Okta to Okta (org2org) flow</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img class="img-fluid" src="./assets/images/org2org.png"/>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <!--<button type="button" class="btn btn-primary">Save changes</button>-->
                </div>
            </div>
        </div>
    </div>
<script type="text/javascript" src="./assets/scripts/main.js"></script>
<script>
 authClient.session.get()
 .then(function(sess){
     console.log("session: "+JSON.stringify(sess));
     if(sess.status === 'ACTIVE') {
         console.log("session exists");
         authClient.tokenManager.get('accessToken') 
        .then(function(token) {
        if (token) {
            // Access token is valid
            let idtoken = JSON.parse(localStorage.getItem("okta-token-storage")).idToken;
            showHeader(idtoken.claims.firstName + " " + idtoken.claims.lastName);
            displayTokens(idtoken,token, true);
        } else {
            console.log("no access token, get tokens without prompt");
            authClient.token.getWithoutPrompt({
                responseType: ['id_token', 'token']
            })
            .then(function(res) {
                console.log("add tokens to token storage");
                var tokens = res.tokens;
                authClient.tokenManager.add('idToken', tokens.idToken);
                authClient.tokenManager.add('accessToken', tokens.accessToken);
                showHeader(res.login);
                displayTokens(tokens.idToken,tokens.accessToken, true);
            })
            .catch(function(err) {
                // handle OAuthError
                console.log("something happened when getting tokens: "+ err);
            });
        }
        });
     }
 })
 .catch(function(err){
     console.log("err: "+err);
 });

var signIn1 = null;
var oktaSignInConfig = {
    baseUrl: oktaBaseTenant,
    clientId: clientId,
    redirectUri: redirectUri_ac,
    authParams: {
        issuer: issuer,
        display: 'page',
        responseType: ['id_token', 'token'],
        scopes: ['openid', 'profile']
    },
    idps: idps_b2b,
    idpDisplay: 'PRIMARY',
    logo: logo,
    features: {
        router: true,
        rememberMe: false,
        multiOptionalFactorEnroll: true,
        idpDiscovery: true
    },
    idpDiscovery: {
        requestContext: bookmarkApp
    },
};

var signIn = new OktaSignIn(oktaSignInConfig);

signIn.renderEl({ el: '#widget-container' });

$(document).ready(function(){        
    $("#tab-1").click(function(e){
        signIn.remove();
        var oktaSignInConfig1 = okta2okta_config;

        signIn1 = new OktaSignIn(oktaSignInConfig1);

        signIn1.renderEl({ el: '#widget-container1' });

    });

    $("#tab-0").click(function(e){
        signIn1.remove();
        var oktaSignInConfig = {
            baseUrl: oktaBaseTenant,
            clientId: clientId,
            redirectUri: redirectUri_ac,
            authParams: {
                issuer: issuer,
                display: 'page',
                responseType: ['id_token', 'token'],
                scopes: ['openid', 'profile']
            },
            idps: idps_b2b,
            idpDisplay: 'PRIMARY',
            logo: logo,
            features: {
                router: true,
                rememberMe: false,
                multiOptionalFactorEnroll: true,
                idpDiscovery: true
            },
            idpDiscovery: {
                requestContext: bookmarkApp 
            },
        };

        signIn = new OktaSignIn(oktaSignInConfig);

        signIn.renderEl({ el: '#widget-container' });
    });
});

function showHeader(name, loggedin) {
    //console.log("showing header...name="+name);
    $(".app-header-right").show();
    $("#user_name").text(name);
}

function displayTokens(idtoken, accesstoken, hasaccesstoken){
    //console.log("show tokens");
    if(hasaccesstoken) {
        $("#accesstokendecoded").text(JSON.stringify(authClient.token.decode(accesstoken.accessToken),null,4));
    }
    $("#idtokendecoded").text(JSON.stringify(authClient.token.decode(idtoken.idToken),null,4));
    
    //console.log("show decoded tokens");
    $("#tokens").show();

}


</script>
</body>
</html>
